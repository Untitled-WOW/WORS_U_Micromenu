EmoteBook = {}
EmoteBook.emotes = {
    { name = "Yes", command = "nod", icon = "Interface\\AddOns\\MicroMenu\\Textures\\EmoteIcon\\1_Yes_emote_icon" },
    { name = "No", command = "no", icon = "Interface\\AddOns\\MicroMenu\\Textures\\EmoteIcon\\2_No_emote_icon" },
    { name = "Bow", command = "Bow", icon = "Interface\\AddOns\\MicroMenu\\Textures\\EmoteIcon\\3_Bow_emote_icon" },
    { name = "Angry", command = "angry", icon = "Interface\\AddOns\\MicroMenu\\Textures\\EmoteIcon\\4_Angry_emote_icon" },
    { name = "Think", command = "think", icon = "Interface\\AddOns\\MicroMenu\\Textures\\EmoteIcon\\5_Think_emote_icon" },
    { name = "Wave", command = "wave", icon = "Interface\\AddOns\\MicroMenu\\Textures\\EmoteIcon\\6_Wave_emote_icon" },
    { name = "Shrug", command = "shrug", icon = "Interface\\AddOns\\MicroMenu\\Textures\\EmoteIcon\\7_Shrug_emote_icon" },
    { name = "Cheer", command = "cheer", icon = "Interface\\AddOns\\MicroMenu\\Textures\\EmoteIcon\\8_Cheer_emote_icon" },
    { name = "Beckon", command = "beckon", icon = "Interface\\AddOns\\MicroMenu\\Textures\\EmoteIcon\\9_Beckon_emote_icon" },
    { name = "Laugh", command = "laugh", icon = "Interface\\AddOns\\MicroMenu\\Textures\\EmoteIcon\\10_Laugh_emote_icon" },
    { name = "Joy", command = "", icon = "Interface\\AddOns\\MicroMenu\\Textures\\EmoteIcon\\11_Jump_for_Joy_emote_icon" },
    { name = "Yawn", command = "Yawn", icon = "Interface\\AddOns\\MicroMenu\\Textures\\EmoteIcon\\12_Yawn_emote_icon" },
    { name = "Dance", command = "dance", icon = "Interface\\AddOns\\MicroMenu\\Textures\\EmoteIcon\\13_Dance_emote_icon" },
    { name = "Shake", command = "shake", icon = "Interface\\AddOns\\MicroMenu\\Textures\\EmoteIcon\\14_Jig_emote_icon" },
    { name = "Tease", command = "tease", icon = "Interface\\AddOns\\MicroMenu\\Textures\\EmoteIcon\\15_Spin_emote_icon" },
    { name = "Bonk", command = "Bonk", icon = "Interface\\AddOns\\MicroMenu\\Textures\\EmoteIcon\\16_Headbang_emote_icon" },
    { name = "Cry", command = "cry", icon = "Interface\\AddOns\\MicroMenu\\Textures\\EmoteIcon\\17_Cry_emote_icon" },
    { name = "Blow", command = "kiss", icon = "Interface\\AddOns\\MicroMenu\\Textures\\EmoteIcon\\18_Blow_Kiss_emote_icon" },
    { name = "Panic", command = "panic", icon = "Interface\\AddOns\\MicroMenu\\Textures\\EmoteIcon\\19_Panic_emote_icon" },
    { name = "Fart", command = "fart", icon = "Interface\\AddOns\\MicroMenu\\Textures\\EmoteIcon\\20_Raspberry_emote_icon" },
    { name = "Clap", command = "clap", icon = "Interface\\AddOns\\MicroMenu\\Textures\\EmoteIcon\\21_Clap_emote_icon" },
    { name = "Salute", command = "salute", icon = "Interface\\AddOns\\MicroMenu\\Textures\\EmoteIcon\\22_Salute_emote_icon" },
	{ name = "Goblin Bow", command = "bow", icon = "Interface\\AddOns\\MicroMenu\\Textures\\EmoteIcon\\23_Goblin_Bow_emote_icon" },
    { name = "Goblin Salute", command = "salute", icon = "Interface\\AddOns\\MicroMenu\\Textures\\EmoteIcon\\24_Goblin_Salute_emote_icon" },
	{ name = "Glass Box", command = "", icon = "Interface\\AddOns\\MicroMenu\\Textures\\EmoteIcon\\25_Glass_Box_emote_icon" },
    { name = "Climb Rope", command = "", icon = "Interface\\AddOns\\MicroMenu\\Textures\\EmoteIcon\\26_Climb_Rope_emote_icon" },
    { name = "Lean", command = "", icon = "Interface\\AddOns\\MicroMenu\\Textures\\EmoteIcon\\27_Lean_emote_icon" },
    { name = "Glass Wall", command = "", icon = "Interface\\AddOns\\MicroMenu\\Textures\\EmoteIcon\\28_Glass_Wall_emote_icon" },
	{ name = "Idea", command = "", icon = "Interface\\AddOns\\MicroMenu\\Textures\\EmoteIcon\\29_Idea_emote_icon" },
    { name = "Stamp", command = "", icon = "Interface\\AddOns\\MicroMenu\\Textures\\EmoteIcon\\30_Stamp_emote_icon" },
    { name = "Flap", command = "", icon = "Interface\\AddOns\\MicroMenu\\Textures\\EmoteIcon\\31_Flap_emote_icon" },
    { name = "Slap Head", command = "", icon = "Interface\\AddOns\\MicroMenu\\Textures\\EmoteIcon\\32_Slap_Head_emote_icon" },
	{ name = "Zombie Walk", command = "", icon = "Interface\\AddOns\\MicroMenu\\Textures\\EmoteIcon\\33_Zombie_Walk_emote_icon" },
    { name = "Zombie Dance", command = "", icon = "Interface\\AddOns\\MicroMenu\\Textures\\EmoteIcon\\34_Zombie_Dance_emote_icon" },
    { name = "Scared", command = "scared", icon = "Interface\\AddOns\\MicroMenu\\Textures\\EmoteIcon\\35_Scared_emote_icon" },
    { name = "Rabbit Hop", command = "", icon = "Interface\\AddOns\\MicroMenu\\Textures\\EmoteIcon\\36_Rabbit_Hop_emote_icon" },
    { name = "Sit Up", command = "", icon = "Interface\\AddOns\\MicroMenu\\Textures\\EmoteIcon\\37_Sit_up_emote_icon" },
    { name = "Push Up", command = "", icon = "Interface\\AddOns\\MicroMenu\\Textures\\EmoteIcon\\38_Push_up_emote_icon" },
    { name = "Star Jump", command = "", icon = "Interface\\AddOns\\MicroMenu\\Textures\\EmoteIcon\\39_Star_jump_emote_icon" },
    { name = "Jog", command = "", icon = "Interface\\AddOns\\MicroMenu\\Textures\\EmoteIcon\\40_Jog_emote_icon" },
    { name = "Flex", command = "flex", icon = "Interface\\AddOns\\MicroMenu\\Textures\\EmoteIcon\\41_Flex_emote_icon" },
    { name = "Zombie Hand", command = "", icon = "Interface\\AddOns\\\MicroMenu\\Textures\\EmoteIcon\\42_Zombie_Hand_emote_icon" },
    { name = "Hypermobile Drinker",	command = "",icon = "Interface\\AddOns\\MicroMenu\\Textures\\EmoteIcon\\43_Hypermobile_Drinker_emote_icon" },
    { name = "Skill Cape", command = "", icon = "Interface\\AddOns\\MicroMenu\\Textures\\EmoteIcon\\44_Skill_Cape_emote_icon" },
    { name = "Air Guitar", command = "", icon = "Interface\\AddOns\\MicroMenu\\Textures\\EmoteIcon\\45_Air_Guitar_emote_icon" },
    { name = "Uri Transform", command = "", icon = "Interface\\AddOns\\MicroMenu\\Textures\\EmoteIcon\\46_Uri_transform_emote_icon" },
    { name = "Smooth Dance", command = "dance", icon = "Interface\\AddOns\\MicroMenu\\Textures\\EmoteIcon\\47_Smooth_dance_emote_icon" },
    { name = "Crazy Dance", command = "dance", icon = "Interface\\AddOns\\MicroMenu\\Textures\\EmoteIcon\\48_Crazy_dance_emote_icon" },
    { name = "Premier Shield", command = "", icon = "Interface\\AddOns\\MicroMenu\\Textures\\EmoteIcon\\49_Premier_Shield_emote_icon" },
    { name = "Explore", command = "", icon = "Interface\\AddOns\\MicroMenu\\Textures\\EmoteIcon\\50_Explore_emote_icon" },
    { name = "Relic Unlock", command = "", icon = "Interface\\AddOns\\MicroMenu\\Textures\\EmoteIcon\\51_Relic_unlock_emote_icon" },
    { name = "Party", command = "", icon = "Interface\\AddOns\\MicroMenu\\Textures\\EmoteIcon\\52_Party_emote_icon" },
    { name = "Trick", command = "", icon = "Interface\\AddOns\\MicroMenu\\Textures\\EmoteIcon\\53_Trick_emote_icon" },
    { name = "Fortis Salute", command = "salute", icon = "Interface\\AddOns\\MicroMenu\\Textures\\EmoteIcon\\54_Fortis_Salute_emote_icon" },
    { name = "Sit Down", command = "sit", icon = "Interface\\AddOns\\MicroMenu\\Textures\\EmoteIcon\\55_Sit_down_emote_icon" },
}

-- Loop through your existing emotes and dynamically register slash commands where commands are _
for _, emoteData in ipairs(EmoteBook.emotes) do
    local cmd = emoteData.command
    if cmd:sub(1,1) == "_" then
        local slashCmd = cmd:sub(2) -- remove the leading underscore
        local slashCmdUpper = slashCmd:upper()

        -- Register the slash command globally
        _G["SLASH_" .. slashCmdUpper .. "1"] = "/" .. slashCmd

        -- Define the command function
        SlashCmdList[slashCmdUpper] = function(msg)
            SendChatMessage(cmd, "SAY")
        end
    end
end


-- ---- FRAME CREATION ----
EmoteBook.frame = CreateFrame("Frame", "EmoteBookFrame", UIParent, "SecureHandlerShowHideTemplate,SecureHandlerStateTemplate,OldSchoolFrameTemplate")
--EmoteBook.frame:SetSize(192, 304)

EmoteBook.frame:SetSize(192, 355)
EmoteBook.frame:SetFrameStrata("LOW")
EmoteBook.frame:SetFrameLevel(1)
tinsert(UISpecialFrames, "EmoteBookFrame")

if EmoteBookFrame and EmoteBookFrame.CloseButton then EmoteBookFrame.CloseButton:ClearAllPoints() end


local bg = EmoteBook.frame:CreateTexture(nil, "LOW")
EmoteBook.frame.Background = bg
bg:SetTexture("Interface\\WORS\\OldSchoolBackground1")
bg:SetAllPoints(EmoteBook.frame)
bg:SetHorizTile(true)
bg:SetVertTile(true)
EmoteBook.frame:Hide()
EmoteBook.frame:SetMovable(true)
EmoteBook.frame:EnableMouse(true)
EmoteBook.frame:RegisterForDrag("LeftButton")
EmoteBook.frame:SetClampedToScreen(true)

EmoteBook.frame:SetScript("OnDragStart", function(self) self:StartMoving() end)
EmoteBook.frame:SetScript("OnDragStop", function(self)
    self:StopMovingOrSizing()
	if WORS_U_MicroMenuAutoClose.Emotes then
		SaveMicroMenuFramePosition(self)
	else
		self:SetUserPlaced(true) 
	end
end)

-- Close button: normal click hides, SHIFT-click resets position
EmoteBook.frame.CloseButton:ClearAllPoints()
EmoteBook.frame.CloseButton:SetPoint("TOPRIGHT", EmoteBook.frame, "TOPRIGHT", 4, 4)

-- Close button tooltip (with shift hint)
EmoteBook.frame.CloseButton:HookScript("OnEnter", function(self)
    GameTooltip:SetOwner(self, "ANCHOR_RIGHT")
    GameTooltip:SetText("Close", 1, 1, 1)
    GameTooltip:Show()
end)
EmoteBook.frame.CloseButton:HookScript("OnLeave", GameTooltip_Hide)

-- ---- SCROLL + BUTTON GRID (your logic, unchanged) ----
local scrollFrame = CreateFrame("ScrollFrame", nil, EmoteBook.frame, "UIPanelScrollFrameTemplate")
scrollFrame:SetSize(180, 340)
scrollFrame:SetPoint("TOPLEFT", 12, -7)
local scrollBar = scrollFrame.ScrollBar
local scrollUpButton = _G[scrollBar:GetName() .. "ScrollUpButton"]
local scrollDownButton = _G[scrollBar:GetName() .. "ScrollDownButton"]
scrollBar:Hide(); scrollBar:SetAlpha(0); scrollUpButton:Hide(); scrollDownButton:Hide(); scrollUpButton:SetAlpha(0); scrollDownButton:SetAlpha(0)
scrollBar:EnableMouse(false)

local buttonContainer = CreateFrame("Frame", nil, scrollFrame)
buttonContainer:SetSize(180, 330)
scrollFrame:SetScrollChild(buttonContainer)

local emoteButtons = {}

local function SetupEmoteButtons(XOffset, YOffset)
    local buttonWidth, buttonHeight = 40, 80
    local padding, columns = 5, 4
    local startX, startY = 2, -10

    for i, emoteData in ipairs(EmoteBook.emotes or {}) do
        local btn = emoteButtons[i]
        if not btn then
            btn = CreateFrame("Button", nil, buttonContainer, "UIPanelButtonTemplate")
            btn:SetSize(buttonWidth, buttonHeight)
            btn:SetNormalTexture(nil)
            btn:SetPushedTexture(nil)
            btn:SetHighlightTexture(nil)
            btn:SetScript("OnEnter", function(self)
                GameTooltip:SetOwner(self, "ANCHOR_RIGHT")
                GameTooltip:ClearLines()
                GameTooltip:SetText(emoteData.name or "", 1, 1, 1)
                GameTooltip:Show()
            end)
            btn:SetScript("OnLeave", GameTooltip_Hide)
            emoteButtons[i] = btn
        end

        local row = math.floor((i - 1) / columns)
        local col = (i - 1) % columns
        local x = XOffset + startX + (buttonWidth + padding) * col
        local y = startY - YOffset - (buttonHeight + padding) * row
        btn:ClearAllPoints()
        btn:SetPoint("TOPLEFT", buttonContainer, "TOPLEFT", x, y)

        btn:SetBackdrop({ bgFile = emoteData.icon })
        if not emoteData.command or emoteData.command == "" then
            btn:SetBackdropColor(0.247, 0.220, 0.153, 1)
            btn:SetScript("OnClick", nil)
        else
            btn:SetBackdropColor(1, 1, 1, 1)
            btn:SetScript("OnClick", function()
                if emoteData.command:sub(1, 1) == "_" then
                    SendChatMessage(emoteData.command, "SAY")
                else
                    DoEmote(emoteData.command)
                end
            end)
        end

        btn:Show()
    end

    for j = #(EmoteBook.emotes or {}) + 1, #emoteButtons do
        if emoteButtons[j] then emoteButtons[j]:Hide() end
    end
end

local function UpdateButtonBackground()
	if InCombatLockdown() then return end
    local b = _G.EmotesMicroButton
    if not b then return end
    if EmoteBook.frame:IsShown() then
        b:SetButtonState("PUSHED", true)   -- lock while open
    else
        b:SetButtonState("NORMAL")         -- unlock when closed
    end
end

EmoteBook.frame:HookScript("OnHide", UpdateButtonBackground)
EmoteBook.frame:HookScript("OnShow", function()
    UpdateButtonBackground()
end)

-- ---- Events ----
local ev = CreateFrame("Frame")
ev:RegisterEvent("ADDON_LOADED")
ev:RegisterEvent("PLAYER_ENTERING_WORLD")
ev:SetScript("OnEvent", function(self, event, arg1)
    if event == "ADDON_LOADED" and arg1 == "MicroMenu" then
        SetupEmoteButtons(-8, -10)
    elseif event == "PLAYER_ENTERING_WORLD" then
		if EmoteBook.frame and not EmoteBook.frame:IsUserPlaced() then
			if WORS_U_MicroMenuAutoClose and WORS_U_MicroMenuAutoClose.AutoClosePOS then
				-- Apply saved position to all auto-close frames
				ApplyMicroMenuSavedPosition()
			else
				-- Fallback to default position
				EmoteBook.frame:ClearAllPoints()
				EmoteBook.frame:SetPoint("RIGHT", UIParent, "RIGHT", -140, 48)
				EmoteBook.frame:SetUserPlaced(true)
			end
		end

		
        -- only needed once
        self:UnregisterEvent("PLAYER_ENTERING_WORLD")
    end
end)

local closeButton = CreateFrame("Button", nil, EmoteBook.frame, "SecureHandlerClickTemplate")
closeButton:SetSize(16, 16)
closeButton:SetPoint("TOPRIGHT", EmoteBook.frame, "TOPRIGHT", 4, 4)
EmoteBook.closeButton = closeButton
closeButton:SetNormalTexture("Interface\\WORS\\OldSchool-CloseButton-Up.blp")
closeButton:SetHighlightTexture("Interface\\WORS\\OldSchool-CloseButton-Highlight.blp", "ADD")
closeButton:SetPushedTexture("Interface\\WORS\\OldSchool-CloseButton-Down.blp")
closeButton:SetFrameRef("uEmoteBook", EmoteBook.frame)
closeButton:SetAttribute("_onclick", [=[
    local uEmoteBook = self:GetFrameRef("uEmoteBook")
    uEmoteBook:SetAttribute("userToggle", nil)
    uEmoteBook:Hide()
]=])


-- =========================
-- Secure Toggle
-- =========================
local EmoteMicroMenuToggle = CreateFrame("Button", "WORS_UEmoteBook_Toggle", UIParent, "SecureHandlerClickTemplate")
if EmotesMicroButton then
	WORS_UEmoteBook_Toggle:ClearAllPoints()
	WORS_UEmoteBook_Toggle:SetParent(EmotesMicroButton)
	WORS_UEmoteBook_Toggle:SetAllPoints(EmotesMicroButton)
	WORS_UEmoteBook_Toggle:SetFrameStrata(EmotesMicroButton:GetFrameStrata())
	WORS_UEmoteBook_Toggle:SetFrameLevel(EmotesMicroButton:GetFrameLevel() + 1)
	WORS_UEmoteBook_Toggle:RegisterForClicks("AnyUp")
	if EmotesMicroButton:GetScript("OnEnter") then
		WORS_UEmoteBook_Toggle:SetScript("OnEnter", function()
			EmotesMicroButton:GetScript("OnEnter")(EmotesMicroButton)
		end)
	end
	if EmotesMicroButton:GetScript("OnLeave") then
		WORS_UEmoteBook_Toggle:SetScript("OnLeave", function()
			EmotesMicroButton:GetScript("OnLeave")(EmotesMicroButton)
		end)
	end
end

EmoteMicroMenuToggle:RegisterForClicks("AnyUp")
EmoteMicroMenuToggle:SetFrameRef("uEmoteBook", EmoteBook.frame)
EmoteMicroMenuToggle:SetAttribute("_onclick", [=[
	local f = self:GetFrameRef("uEmoteBook")
	if not f then return end
	
	if not f:IsShown() then
		f:Show()
	else
		f:Hide()
	end
]=])

EmoteMicroMenuToggle:SetScript("PostClick", function(self, button, down)
	if WORS_U_MicroMenuAutoClose.Emotes then	
		if WORS_U_MicroMenuAutoClose.Backpack and Backpack and Backpack:IsShown() then
			Backpack:Hide()
		end
		
		if WORS_U_MicroMenuAutoClose.CombatStyle and CombatStylePanel and CombatStylePanel:IsShown() then
			CombatStylePanel:Hide()
		end	
		
		if WORS_U_MicroMenuAutoClose.Magic and WORS_U_SpellBookFrame and WORS_U_SpellBookFrame:IsShown() then
			WORS_U_SpellBookFrame:Hide()
		end

		if WORS_U_MicroMenuAutoClose.Equipment and WORS_U_EquipmentBookFrame and WORS_U_EquipmentBookFrame:IsShown() then
			WORS_U_EquipmentBookFrame:Hide()
		end

		if WORS_U_MicroMenuAutoClose.Prayer and WORS_U_PrayBookFrame and WORS_U_PrayBookFrame:IsShown() then
			WORS_U_PrayBookFrame:Hide()
		end

		if WORS_U_MicroMenuAutoClose.Skills and WORS_U_SkillsBookFrame and WORS_U_SkillsBookFrame:IsShown() then
			WORS_U_SkillsBookFrame:Hide()
		end	

	end
end)

-- =========================
-- Keybind Secure Toggle 
-- =========================
local kb = CreateFrame("Frame")
kb:RegisterEvent("PLAYER_LOGIN")
kb:RegisterEvent("UPDATE_BINDINGS")
kb:RegisterEvent("PLAYER_REGEN_ENABLED")
kb:SetScript("OnEvent", function(self, event)
	if InCombatLockdown() then
		self.need = true
		return
	end
	-- bind both keys for TOGGLEEMOTE
	local k1, k2 = GetBindingKey("TOGGLEEMOTE")
	if k1 then SetOverrideBindingClick(UIParent, true, k1, "WORS_UEmoteBook_Toggle", "LeftButton") end
	if k2 then SetOverrideBindingClick(UIParent, true, k2, "WORS_UEmoteBook_Toggle", "LeftButton") end

	if event == "PLAYER_REGEN_ENABLED" then
		self.need = nil
	end
end)
